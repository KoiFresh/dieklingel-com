<!DOCTYPE html>
<html >
<head><meta charset="utf-8">
<title>FHEM als Türöffner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:title" content="FHEM als Türöffner">
<meta name="description" content="Wie man FHEM benutzt um mittels Passcode die Haustür zu öffnen">
<meta property="og:description" content="Wie man FHEM benutzt um mittels Passcode die Haustür zu öffnen"><link rel="preload" as="fetch" crossorigin="anonymous" href="/blog/fhem-als-tueroeffner/_payload.json"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.5d05c411.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/blog.6cc4024d.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_...slug_.64460c7f.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentDoc.a65367a5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.1bdf0124.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.a47d0381.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.a6ef77ff.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/preview.cefff628.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentQuery.683dbff4.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.e6a7d0f8.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.489a0623.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH1.0b57f18c.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.eb7cdb2a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCodeInline.9e7ddd6b.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.508c8c4e.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/nuxt-link.449f4599.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.a24e33d5.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/default.60097173.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-404.80654368.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-500.efa9ddd0.js"><style>body[data-v-93738ebb],html[data-v-93738ebb]{margin:0;padding:0}</style><style>@import url("https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css");.main[data-v-1b3bf56c]{padding:0 2em}</style><style>pre code .line{display:block;min-height:1rem}</style></head>
<body ><div id="__nuxt"><div><div class="blog" data-v-93738ebb><div class="markdown-body main" data-v-1b3bf56c><!--[--><div><h1 id="fhem-als-türöffner"><!--[-->FHEM als Türöffner<!--]--></h1><p><!--[-->Der Core der Klingel bietet im wesentlichen eine Schnittstelle via MQTT an, über diese verschiedene Events abgerufen oder ausgelöst werden können. Eine integration für weitere Schnittstellen gibt es nicht (bis auf einen mqtt-http-proxy). Das stellt uns jedoch kaum vor ein Problem, da es genügend Systeme mit MQTT integration gibt, die problemlos weitere Aufgaben für uns übernehmen können. So werden wir im folgenden FHEM so konfigurieren, dass ein Pin des Raspberry Pi&#39;s beim eingeben von <code><!--[-->123456789<!--]--></code> als Passcode auf der Kiosk Anwendung des dieKlingel Software Packetes für drei Sekunden auf HIGH und danach wieder auf LOW geschaltet wird.<!--]--></p><p><!--[-->Zu allererst werden wir in FHEM ein neues Gerät anlegen, welches den GPIO Pin 17 (<a href="https://pinout.xyz/pinout/pin11_gpio17/" rel="nofollow"><!--[-->Pin 11<!--]--></a>) am Rasperry Pi für drei Sekunden auf HIGH und danach wieder auf LOW schaltet.<!--]--></p><!--[--><pre><code><span class="line" line="1"><span class="ct-970031">sudo</span><span class="ct-996399"> </span><span class="ct-724922">addgroup</span><span class="ct-996399"> </span><span class="ct-724922">fhem</span><span class="ct-996399"> </span><span class="ct-724922">gpio</span></span></code></pre><!--]--><p><!--[-->In der Fhem Befehlszeile:<!--]--></p><!--[--><pre><code><span class="line" line="1"><span>define frontdoor RPI_GPIO 17
</span></span><span class="line" line="2"><span>attr frontdoor direction output</span></span></code></pre><!--]--><p><!--[-->So da wir nun den Pin als Gerät angelegt habe, können wir den Pin für drei Sekunden auf HIGH schalten<!--]--></p><!--[--><pre><code><span class="line" line="1"><span>set frontdoor on-for-timer 3</span></span></code></pre><!--]--><p><!--[-->Jetzt legen wir uns in der Konfiguration des Cores noch eine Lane an, welche per <a href="https://wiki.fhem.de/wiki/CsrfToken-HowTo" rel="nofollow"><!--[-->HTTP den FHEM befehl<!--]--></a> ausführt und den Passcode überprüft. Um den FHEM Befehl auszuführen nehmen wir uns ein kurzes Python Script zu Hilfe<!--]--></p><!--[--><pre><code><span class="line" line="1"><span class="ct-748473">import</span><span class="ct-996399"> os, json, requests, sys
</span></span><span class="line" line="2"><span>
</span></span><span class="line" line="3"><span class="ct-996399">url </span><span class="ct-748473">=</span><span class="ct-996399"> sys.argv[</span><span class="ct-531245">1</span><span class="ct-996399">]
</span></span><span class="line" line="4"><span>
</span></span><span class="line" line="5"><span class="ct-996399">response </span><span class="ct-748473">=</span><span class="ct-996399"> requests.request(</span><span class="ct-724922">&quot;GET&quot;</span><span class="ct-996399">, url)
</span></span><span class="line" line="6"><span class="ct-996399">token </span><span class="ct-748473">=</span><span class="ct-996399"> response.headers[</span><span class="ct-724922">&quot;X-FHEM-csrfToken&quot;</span><span class="ct-996399">]
</span></span><span class="line" line="7"><span class="ct-996399">requests.request(</span><span class="ct-724922">&quot;GET&quot;</span><span class="ct-996399">, url </span><span class="ct-748473">+</span><span class="ct-996399"> </span><span class="ct-724922">&quot;&amp;XHR=1&amp;fwcsrf=&quot;</span><span class="ct-996399"> </span><span class="ct-748473">+</span><span class="ct-996399"> token)</span></span></code></pre><!--]--><p><!--[-->Dieses legen wir im Ordner <code><!--[-->scripts<!--]--></code> im <code><!--[-->$DIEKLINGEL_HOME<!--]--></code> Verzeichnis ab. Wenn die Anwendung als Snap läuft befindet sich das Home Verzeichnis unter <code><!--[-->/var/snap/dieklingel-core/current<!--]--></code>. Jetzt könne wir eine Lane erstellen, welches den Passcode überprüft und bei korrektem Passcode das eben erstellte Script aufruft.<!--]--></p><!--[--><pre><code><span class="line" line="1"><span class="ct-802111">actions</span><span class="ct-996399">:
</span></span><span class="line" line="2"><span class="ct-996399">  - </span><span class="ct-802111">trigger</span><span class="ct-996399">: </span><span class="ct-724922">^unlock$
</span></span><span class="line" line="3"><span class="ct-996399">    </span><span class="ct-802111">lane</span><span class="ct-996399">: </span><span class="ct-748473">|</span><span class="ct-935236"> 
</span></span><span class="line" line="4"><span class="ct-724922">      if [ &quot;$PASSCODE&quot; = &quot;123456789&quot; ]; then
</span></span><span class="line" line="5"><span class="ct-724922">        python3 ./scripts/fhem.py &quot;http://192.168.177.52:8083/fhem?cmd=set frontdoor on-for-timer 3&quot;
</span></span><span class="line" line="6"><span class="ct-724922">      fi</span></span></code></pre><!--]--><p><!--[-->Das wars auch schon. Sobal nun der Passcode <code><!--[-->123456789<!--]--></code> eingegeben wird, wird via FHEM der GPIO Pin 17 für 3 Sekunden auf HIGH geschaltet, befindet sich am Pin ein Relais, so kann mit diesem die Haustür geöffnet werden. Jede andere Passcode Eingabe wird ignoriert.<!--]--></p><style>.ct-970031{color:#6F42C1;}
.ct-996399{color:#24292E;}
.ct-724922{color:#032F62;}
.ct-748473{color:#D73A49;}
.ct-531245{color:#005CC5;}
.ct-802111{color:#22863A;}
.ct-935236{color:#B31D28;font-style:italic;}</style></div><!--]--></div></div></div></div><script type="application/json" id="__NUXT_DATA__" data-ssr="true" data-src="/blog/fhem-als-tueroeffner/_payload.json">[{"state":1,"_errors":3,"serverRendered":6,"path":7,"prerenderedAt":8},["Reactive",2],{},["Reactive",4],{"content-query-b4YTKxhAjB":5},null,true,"/blog/fhem-als-tueroeffner",1708158384222]</script><script>window.__NUXT__={};window.__NUXT__.config={public:{content:{locales:[],defaultLocale:"",integrity:1708158374655,experimental:{stripQueryParameters:false,clientDB:false},respectPathCase:false,api:{baseURL:"/api/_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:{theme:{default:"github-light"}},wsUrl:"",documentDriven:false,host:"",trailingSlash:false,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"/",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script><script type="module" src="/_nuxt/entry.5d05c411.js" crossorigin></script></body>
</html>