[{"_path":"/blog/doorunit-design-v2","_dir":"blog","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"doorunit-design-v2","description":"How we redesinged the whole doorunit, based on experience from version 1","lang":"English üá¨üáß","author":"Kai Mayer","tags":["CAD","design","hardware"],"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"doorunit-design-v2"},"children":[{"type":"text","value":"doorunit-design-v2"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Hey, this articel isn't finished yet, come back in few days..."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:blog:doorunit-design-v2.md","_source":"content","_file":"blog/doorunit-design-v2.md","_extension":"md"},{"_path":"/blog/fhem-als-tueroeffner","_dir":"blog","_draft":false,"_partial":false,"_locale":"","_empty":false,"title":"FHEM als T√ºr√∂ffner","description":"Wie man FHEM benutzt um mittels Passcode die Haust√ºr zu √∂ffnen","lang":"German üá©üá™","created":"2023-08-18T00:00:00.000Z","author":"Kai Mayer","tags":["fhem","raspberrypi","actions","smarthome","mqtt"],"body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"fhem-als-t√ºr√∂ffner"},"children":[{"type":"text","value":"FHEM als T√ºr√∂ffner"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Der Core der Klingel bietet im wesentlichen eine Schnittstelle via MQTT an, √ºber diese verschiedene Events abgerufen oder ausgel√∂st werden k√∂nnen. Eine integration f√ºr weitere Schnittstellen gibt es nicht (bis auf einen mqtt-http-proxy). Das stellt uns jedoch kaum vor ein Problem, da es gen√ºgend Systeme mit MQTT integration gibt, die problemlos weitere Aufgaben f√ºr uns √ºbernehmen k√∂nnen. So werden wir im folgenden FHEM so konfigurieren, dass ein Pin des Raspberry Pi's beim eingeben von "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"123456789"}]},{"type":"text","value":" als Passcode auf der Kiosk Anwendung des dieKlingel Software Packetes f√ºr drei Sekunden auf HIGH und danach wieder auf LOW geschaltet wird."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Zu allererst werden wir in FHEM ein neues Ger√§t anlegen, welches den GPIO Pin 17 ("},{"type":"element","tag":"a","props":{"href":"https://pinout.xyz/pinout/pin11_gpio17/","rel":["nofollow"]},"children":[{"type":"text","value":"Pin 11"}]},{"type":"text","value":") am Rasperry Pi f√ºr drei Sekunden auf HIGH und danach wieder auf LOW schaltet."}]},{"type":"element","tag":"code","props":{"className":["language-bash"],"code":"sudo addgroup fhem gpio\n","language":"bash","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-970031"},"children":[{"type":"text","value":"sudo"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"addgroup"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"fhem"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"gpio"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In der Fhem Befehlszeile:"}]},{"type":"element","tag":"code","props":{"className":["language-fhem"],"code":"define frontdoor RPI_GPIO 17\nattr frontdoor direction output\n","language":"fhem","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"define frontdoor RPI_GPIO 17\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"attr frontdoor direction output"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"So da wir nun den Pin als Ger√§t angelegt habe, k√∂nnen wir den Pin f√ºr drei Sekunden auf HIGH schalten"}]},{"type":"element","tag":"code","props":{"className":["language-fhem"],"code":"set frontdoor on-for-timer 3\n","language":"fhem","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set frontdoor on-for-timer 3"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Jetzt legen wir uns in der Konfiguration des Cores noch eine Lane an, welche per "},{"type":"element","tag":"a","props":{"href":"https://wiki.fhem.de/wiki/CsrfToken-HowTo","rel":["nofollow"]},"children":[{"type":"text","value":"HTTP den FHEM befehl"}]},{"type":"text","value":" ausf√ºhrt und den Passcode √ºberpr√ºft. Um den FHEM Befehl auszuf√ºhren nehmen wir uns ein kurzes Python Script zu Hilfe"}]},{"type":"element","tag":"code","props":{"className":["language-python"],"code":"import os, json, requests, sys\n\nurl = sys.argv[1]\n\nresponse = requests.request(\"GET\", url)\ntoken = response.headers[\"X-FHEM-csrfToken\"]\nrequests.request(\"GET\", url + \"&XHR=1&fwcsrf=\" + token)\n","language":"python","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" os, json, requests, sys\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"url "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" sys.argv["}]},{"type":"element","tag":"span","props":{"class":"ct-531245"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"response "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" requests.request("}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"\"GET\""}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":", url)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"token "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" response.headers["}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"\"X-FHEM-csrfToken\""}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"requests.request("}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"\"GET\""}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":", url "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"\"&XHR=1&fwcsrf=\""}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"+"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":" token)"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Dieses legen wir im Ordner "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"scripts"}]},{"type":"text","value":" im "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"$DIEKLINGEL_HOME"}]},{"type":"text","value":" Verzeichnis ab. Wenn die Anwendung als Snap l√§uft befindet sich das Home Verzeichnis unter "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"/var/snap/dieklingel-core/current"}]},{"type":"text","value":". Jetzt k√∂nne wir eine Lane erstellen, welches den Passcode √ºberpr√ºft und bei korrektem Passcode das eben erstellte Script aufruft."}]},{"type":"element","tag":"code","props":{"className":["language-yaml"],"code":"actions:\n  - trigger: ^unlock$\n    lane: | \n      if [ \"$PASSCODE\" = \"123456789\" ]; then\n        python3 ./scripts/fhem.py \"http://192.168.177.52:8083/fhem?cmd=set frontdoor on-for-timer 3\"\n      fi\n","language":"yaml","meta":""},"children":[{"type":"element","tag":"pre","props":{},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"class":"ct-802111"},"children":[{"type":"text","value":"actions"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"class":"ct-802111"},"children":[{"type":"text","value":"trigger"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"^unlock$\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":"    "}]},{"type":"element","tag":"span","props":{"class":"ct-802111"},"children":[{"type":"text","value":"lane"}]},{"type":"element","tag":"span","props":{"class":"ct-996399"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"class":"ct-748473"},"children":[{"type":"text","value":"|"}]},{"type":"element","tag":"span","props":{"class":"ct-935236"},"children":[{"type":"text","value":" \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"      if [ \"$PASSCODE\" = \"123456789\" ]; then\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"        python3 ./scripts/fhem.py \"http://192.168.177.52:8083/fhem?cmd=set frontdoor on-for-timer 3\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"class":"ct-724922"},"children":[{"type":"text","value":"      fi"}]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Das wars auch schon. Sobal nun der Passcode "},{"type":"element","tag":"code-inline","props":{},"children":[{"type":"text","value":"123456789"}]},{"type":"text","value":" eingegeben wird, wird via FHEM der GPIO Pin 17 f√ºr 3 Sekunden auf HIGH geschaltet, befindet sich am Pin ein Relais, so kann mit diesem die Haust√ºr ge√∂ffnet werden. Jede andere Passcode Eingabe wird ignoriert."}]},{"type":"element","tag":"style","children":[{"type":"text","value":".ct-970031{color:#6F42C1;}\n.ct-996399{color:#24292E;}\n.ct-724922{color:#032F62;}\n.ct-748473{color:#D73A49;}\n.ct-531245{color:#005CC5;}\n.ct-802111{color:#22863A;}\n.ct-935236{color:#B31D28;font-style:italic;}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[]}},"_type":"markdown","_id":"content:blog:fhem-als-tueroeffner.md","_source":"content","_file":"blog/fhem-als-tueroeffner.md","_extension":"md"}]